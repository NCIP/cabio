//>>built
define("dijit/form/_AutoCompleterMixin",["dojo/data/util/filter","dojo/_base/declare","dojo/_base/Deferred","dojo/dom-attr","dojo/_base/event","dojo/keys","dojo/_base/lang","dojo/query","dojo/regexp","dojo/sniff","dojo/string","dojo/_base/window","./DataList","../registry","./_TextBoxMixin"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){return _2("dijit.form._AutoCompleterMixin",null,{item:null,pageSize:Infinity,store:null,fetchProperties:{},query:{},autoComplete:true,highlightMatch:"first",searchDelay:100,searchAttr:"name",labelAttr:"",labelType:"text",queryExpr:"${0}*",ignoreCase:true,maxHeight:-1,_stopClickEvents:false,_getCaretPos:function(_10){var pos=0;if(typeof (_10.selectionStart)=="number"){pos=_10.selectionStart;}else{if(_a("ie")){var tr=_c.doc.selection.createRange().duplicate();var ntr=_10.createTextRange();tr.move("character",0);ntr.move("character",0);try{ntr.setEndPoint("EndToEnd",tr);pos=String(ntr.text).replace(/\r/g,"").length;}catch(e){}}}return pos;},_setCaretPos:function(_11,_12){_12=parseInt(_12);_f.selectInputText(_11,_12,_12);},_setDisabledAttr:function(_13){this.inherited(arguments);this.domNode.setAttribute("aria-disabled",_13?"true":"false");},_abortQuery:function(){if(this.searchTimer){clearTimeout(this.searchTimer);this.searchTimer=null;}if(this._fetchHandle){if(this._fetchHandle.cancel){this._cancelingQuery=true;this._fetchHandle.cancel();this._cancelingQuery=false;}this._fetchHandle=null;}},_onInput:function(evt){this.inherited(arguments);if(evt.charOrCode==229){this._onKey(evt);}},_onKey:function(evt){var key=evt.charOrCode;if(evt.altKey||((evt.ctrlKey||evt.metaKey)&&(key!="x"&&key!="v"))||key==_6.SHIFT){return;}var _14=false;var pw=this.dropDown;var _15=null;this._prev_key_backspace=false;this._abortQuery();this.inherited(arguments);if(this._opened){_15=pw.getHighlightedOption();}switch(key){case _6.PAGE_DOWN:case _6.DOWN_ARROW:case _6.PAGE_UP:case _6.UP_ARROW:if(this._opened){this._announceOption(_15);}_5.stop(evt);break;case _6.ENTER:if(_15){if(_15==pw.nextButton){this._nextSearch(1);_5.stop(evt);break;}else{if(_15==pw.previousButton){this._nextSearch(-1);_5.stop(evt);break;}}}else{this._setBlurValue();this._setCaretPos(this.focusNode,this.focusNode.value.length);}if(this._opened||this._fetchHandle){_5.stop(evt);}case _6.TAB:var _16=this.get("displayedValue");if(pw&&(_16==pw._messages["previousMessage"]||_16==pw._messages["nextMessage"])){break;}if(_15){this._selectOption(_15);}case _6.ESCAPE:if(this._opened){this._lastQuery=null;this.closeDropDown();}break;case " ":if(_15){_5.stop(evt);this._selectOption(_15);this.closeDropDown();}else{_14=true;}break;case _6.DELETE:case _6.BACKSPACE:this._prev_key_backspace=true;_14=true;break;default:_14=typeof key=="string"||key==229;}if(_14){this.item=undefined;this.searchTimer=setTimeout(_7.hitch(this,"_startSearchFromInput"),1);}},_autoCompleteText:function(_17){var fn=this.focusNode;_f.selectInputText(fn,fn.value.length);var _18=this.ignoreCase?"toLowerCase":"substr";if(_17[_18](0).indexOf(this.focusNode.value[_18](0))==0){var _19=this.autoComplete?this._getCaretPos(fn):fn.value.length;if((_19+1)>fn.value.length){fn.value=_17;_f.selectInputText(fn,_19);}}else{fn.value=_17;_f.selectInputText(fn);}},_openResultList:function(_1a,_1b,_1c){this._fetchHandle=null;if(this.disabled||this.readOnly||(_1b[this.searchAttr]!==this._lastQuery)){return;}var _1d=this.dropDown.getHighlightedOption();this.dropDown.clearResultList();if(!_1a.length&&_1c.start==0){this.closeDropDown();return;}var _1e=this.dropDown.createOptions(_1a,_1c,_7.hitch(this,"_getMenuLabelFromItem"));this._showResultList();if(_1c.direction){if(1==_1c.direction){this.dropDown.highlightFirstOption();}else{if(-1==_1c.direction){this.dropDown.highlightLastOption();}}if(_1d){this._announceOption(this.dropDown.getHighlightedOption());}}else{if(this.autoComplete&&!this._prev_key_backspace&&!/^[*]+$/.test(_1b[this.searchAttr].toString())){this._announceOption(_1e[1]);}}},_showResultList:function(){this.closeDropDown(true);this.openDropDown();this.domNode.setAttribute("aria-expanded","true");},loadDropDown:function(){this._startSearchAll();},isLoaded:function(){return false;},closeDropDown:function(){this._abortQuery();if(this._opened){this.inherited(arguments);this.domNode.setAttribute("aria-expanded","false");this.focusNode.removeAttribute("aria-activedescendant");}},_setBlurValue:function(){var _1f=this.get("displayedValue");var pw=this.dropDown;if(pw&&(_1f==pw._messages["previousMessage"]||_1f==pw._messages["nextMessage"])){this._setValueAttr(this._lastValueReported,true);}else{if(typeof this.item=="undefined"){this.item=null;this.set("displayedValue",_1f);}else{if(this.value!=this._lastValueReported){this._handleOnChange(this.value,true);}this._refreshState();}}},_setItemAttr:function(_20,_21,_22){var _23="";if(_20){if(!_22){_22=this.store._oldAPI?this.store.getValue(_20,this.searchAttr):_20[this.searchAttr];}_23=this._getValueField()!=this.searchAttr?this.store.getIdentity(_20):_22;}this.set("value",_23,_21,_22,_20);},_announceOption:function(_24){if(!_24){return;}var _25;if(_24==this.dropDown.nextButton||_24==this.dropDown.previousButton){_25=_24.innerHTML;this.item=undefined;this.value="";}else{_25=(this.store._oldAPI?this.store.getValue(_24.item,this.searchAttr):_24.item[this.searchAttr]).toString();this.set("item",_24.item,false,_25);}this.focusNode.value=this.focusNode.value.substring(0,this._lastInput.length);this.focusNode.setAttribute("aria-activedescendant",_4.get(_24,"id"));this._autoCompleteText(_25);},_selectOption:function(_26){this.closeDropDown();if(_26){this._announceOption(_26);}this._setCaretPos(this.focusNode,this.focusNode.value.length);this._handleOnChange(this.value,true);},_startSearchAll:function(){this._startSearch("");},_startSearchFromInput:function(){this._startSearch(this.focusNode.value.replace(/([\\\*\?])/g,"\\$1"));},_getQueryString:function(_27){return _b.substitute(this.queryExpr,[_27]);},_startSearch:function(key){if(!this.dropDown){var _28=this.id+"_popup",_29=_7.isString(this.dropDownClass)?_7.getObject(this.dropDownClass,false):this.dropDownClass;this.dropDown=new _29({onChange:_7.hitch(this,this._selectOption),id:_28,dir:this.dir,textDir:this.textDir});this.focusNode.removeAttribute("aria-activedescendant");this.textbox.setAttribute("aria-owns",_28);}this._lastInput=key;var _2a=_7.clone(this.query);var _2b={start:0,count:this.pageSize,queryOptions:{ignoreCase:this.ignoreCase,deep:true}};_7.mixin(_2b,this.fetchProperties);var qs=this._getQueryString(key),q;if(this.store._oldAPI){q=qs;}else{q=_1.patternToRegExp(qs,this.ignoreCase);q.toString=function(){return qs;};}this._lastQuery=_2a[this.searchAttr]=q;var _2c=this,_2d=function(){var _2e=_2c._fetchHandle=_2c.store.query(_2a,_2b);_3.when(_2e,function(res){_2c._fetchHandle=null;res.total=_2e.total;_2c._openResultList(res,_2a,_2b);},function(err){_2c._fetchHandle=null;if(!_2c._cancelingQuery){console.error(_2c.declaredClass+" "+err.toString());_2c.closeDropDown();}});};this.searchTimer=setTimeout(_7.hitch(this,function(_2f,_30){this.searchTimer=null;_2d();this._nextSearch=this.dropDown.onPage=function(_31){_2b.start+=_2b.count*_31;_2b.direction=_31;_2d();_30.focus();};},_2a,this),this.searchDelay);},_getValueField:function(){return this.searchAttr;},constructor:function(){this.query={};this.fetchProperties={};},postMixInProperties:function(){if(!this.store){var _32=this.srcNodeRef;var _33=this.list;if(_33){this.store=_e.byId(_33);}else{this.store=new _d({},_32);}if(!("value" in this.params)){var _34=(this.item=this.store.fetchSelectedItem());if(_34){var _35=this._getValueField();this.value=this.store._oldAPI?this.store.getValue(_34,_35):_34[_35];}}}this.inherited(arguments);},postCreate:function(){var _36=_8("label[for=\""+this.id+"\"]");if(_36.length){_36[0].id=(this.id+"_label");this.domNode.setAttribute("aria-labelledby",_36[0].id);}this.inherited(arguments);},_getMenuLabelFromItem:function(_37){var _38=this.labelFunc(_37,this.store),_39=this.labelType;if(this.highlightMatch!="none"&&this.labelType=="text"&&this._lastInput){_38=this.doHighlight(_38,this._lastInput);_39="html";}return {html:_39=="html",label:_38};},doHighlight:function(_3a,_3b){var _3c=(this.ignoreCase?"i":"")+(this.highlightMatch=="all"?"g":""),i=this.queryExpr.indexOf("${0}");_3b=_9.escapeString(_3b);return this._escapeHtml(_3a.replace(new RegExp((i==0?"^":"")+"("+_3b+")"+(i==(this.queryExpr.length-4)?"$":""),_3c),"￿$1￿")).replace(/\uFFFF([^\uFFFF]+)\uFFFF/g,"<span class=\"dijitComboBoxHighlightMatch\">$1</span>");},_escapeHtml:function(str){str=String(str).replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;");return str;},reset:function(){this.item=null;this.inherited(arguments);},labelFunc:function(_3d,_3e){return (_3e._oldAPI?_3e.getValue(_3d,this.labelAttr||this.searchAttr):_3d[this.labelAttr||this.searchAttr]).toString();},_setValueAttr:function(_3f,_40,_41,_42){this._set("item",_42||null);if(!_3f){_3f="";}this.inherited(arguments);},_setTextDirAttr:function(_43){this.inherited(arguments);if(this.dropDown){this.dropDown._set("textDir",_43);}}});});