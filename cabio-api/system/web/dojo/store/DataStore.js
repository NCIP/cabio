/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

//>>built
define("dojo/store/DataStore",["../_base/lang","../_base/declare","../_base/Deferred","../_base/array","./util/QueryResults"],function(_1,_2,_3,_4,_5){return _2("dojo.store.DataStore",null,{target:"",constructor:function(_6){_1.mixin(this,_6);if(!"idProperty" in _6){var _7;try{_7=this.store.getIdentityAttributes();}catch(e){}this.idProperty=(!_7||!idAttributes[0])||this.idProperty;}var _8=this.store.getFeatures();if(!_8["dojo.data.api.Read"]){this.get=null;}if(!_8["dojo.data.api.Identity"]){this.getIdentity=null;}if(!_8["dojo.data.api.Write"]){this.put=this.add=null;}},idProperty:"id",store:null,_objectConverter:function(_9){var _a=this.store;var _b=this.idProperty;function _c(_d){var _e={};var _f=_a.getAttributes(_d);for(var i=0;i<_f.length;i++){var _10=_f[i];var _11=_a.getValues(_d,_10);if(_11.length>1){for(var j=0;j<_11.length;j++){var _12=_11[j];if(typeof _12=="object"&&_a.isItem(_12)){_11[j]=_c(_12);}}_12=_11;}else{var _12=_a.getValue(_d,_10);if(typeof _12=="object"&&_a.isItem(_12)){_12=_c(_12);}}_e[_f[i]]=_12;}if(!(_b in _e)){_e[_b]=_a.getIdentity(_d);}return _e;};return function(_13){return _9(_c(_13));};},get:function(id,_14){var _15,_16;var _17=new _3();this.store.fetchItemByIdentity({identity:id,onItem:this._objectConverter(function(_18){_17.resolve(_15=_18);}),onError:function(_19){_17.reject(_16=_19);}});if(_15){return _15;}if(_16){throw _16;}return _17.promise;},put:function(_1a,_1b){var id=_1b&&typeof _1b.id!="undefined"||this.getIdentity(_1a);var _1c=this.store;var _1d=this.idProperty;if(typeof id=="undefined"){_1c.newItem(_1a);}else{_1c.fetchItemByIdentity({identity:id,onItem:function(_1e){if(_1e){for(var i in _1a){if(i!=_1d&&_1c.getValue(_1e,i)!=_1a[i]){_1c.setValue(_1e,i,_1a[i]);}}}else{_1c.newItem(_1a);}}});}},remove:function(id){var _1f=this.store;this.store.fetchItemByIdentity({identity:id,onItem:function(_20){_1f.deleteItem(_20);}});},query:function(_21,_22){var _23;var _24=new _3(function(){_23.abort&&_23.abort();});_24.total=new _3();var _25=this._objectConverter(function(_26){return _26;});_23=this.store.fetch(_1.mixin({query:_21,onBegin:function(_27){_24.total.resolve(_27);},onComplete:function(_28){_24.resolve(_4.map(_28,_25));},onError:function(_29){_24.reject(_29);}},_22));return _5(_24);},getIdentity:function(_2a){return _2a[this.idProperty];}});});