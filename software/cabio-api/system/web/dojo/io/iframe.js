/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

//>>built
define("dojo/io/iframe",["../_base/config","../_base/json","../_base/kernel","../_base/lang","../_base/xhr","../sniff","../_base/window","../dom","../dom-construct","../query","require"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c={create:function(_d,_e,_f){if(window[_d]){return window[_d];}if(window.frames[_d]){return window.frames[_d];}var _10=_f;if(!_10){if(_1["useXDomain"]&&!_1["dojoBlankHtmlUrl"]){console.warn("dojo.io.iframe.create: When using cross-domain Dojo builds,"+" please save dojo/resources/blank.html to your domain and set djConfig.dojoBlankHtmlUrl"+" to the path on your domain to blank.html");}_10=(_1["dojoBlankHtmlUrl"]||_b.toUrl("../resources/blank.html"));}var _11=_9.place("<iframe id=\""+_d+"\" name=\""+_d+"\" src=\""+_10+"\" onload=\""+_e+"\" style=\"position: absolute; left: 1px; top: 1px; height: 1px; width: 1px; visibility: hidden\">",_7.body());window[_d]=_11;return _11;},setSrc:function(_12,src,_13){try{if(!_13){if(_6("webkit")){_12.location=src;}else{frames[_12.name].location=src;}}else{var _14;if(_6("ie")||_6("webkit")){_14=_12.contentWindow.document;}else{_14=_12.contentWindow;}if(!_14){_12.location=src;}else{_14.location.replace(src);}}}catch(e){}},doc:function(_15){return _15.contentDocument||(((_15.name)&&(_15.document)&&(_7.doc.getElementsByTagName("iframe")[_15.name].contentWindow)&&(_7.doc.getElementsByTagName("iframe")[_15.name].contentWindow.document)))||((_15.name)&&(_7.doc.frames[_15.name])&&(_7.doc.frames[_15.name].document))||null;},send:function(_16){if(!this["_frame"]){this._frame=this.create(this._iframeName,_3._scopeName+".io.iframe._iframeOnload();");}var dfd=_5._ioSetArgs(_16,function(dfd){dfd.canceled=true;dfd.ioArgs._callNext();},function(dfd){var _17=null;try{var _18=dfd.ioArgs;var ifd=_c.doc(_c._frame);var _19=_18.handleAs;_17=ifd;if(_19!="html"){if(_19=="xml"){if(_6("ie")<9||(_6("ie")&&_6("quirks"))){_a("a",_c._frame.contentWindow.document.documentElement).orphan();var _1a=(_c._frame.contentWindow.document).documentElement.innerText;_1a=_1a.replace(/>\s+</g,"><");_1a=_4.trim(_1a);var _1b={responseText:_1a};_17=_5.contentHandlers["xml"](_1b);}}else{_17=ifd.getElementsByTagName("textarea")[0].value;if(_19=="json"){_17=_2.fromJson(_17);}else{if(_19=="javascript"){_17=_3.eval(_17);}}}}}catch(e){_17=e;}finally{_18._callNext();}return _17;},function(_1c,dfd){dfd.ioArgs._hasError=true;dfd.ioArgs._callNext();return _1c;});dfd.ioArgs._callNext=function(){if(!this["_calledNext"]){this._calledNext=true;_c._currentDfd=null;_c._fireNextRequest();}};this._dfdQueue.push(dfd);this._fireNextRequest();_5._ioWatch(dfd,function(dfd){return !dfd.ioArgs["_hasError"];},function(dfd){return (!!dfd.ioArgs["_finished"]);},function(dfd){if(dfd.ioArgs._finished){dfd.callback(dfd);}else{dfd.errback(new Error("Invalid dojo.io.iframe request state"));}});return dfd;},_currentDfd:null,_dfdQueue:[],_iframeName:_3._scopeName+"IoIframe",_fireNextRequest:function(){try{if((this._currentDfd)||(this._dfdQueue.length==0)){return;}do{var dfd=this._currentDfd=this._dfdQueue.shift();}while(dfd&&dfd.canceled&&this._dfdQueue.length);if(!dfd||dfd.canceled){this._currentDfd=null;return;}var _1d=dfd.ioArgs;var _1e=_1d.args;_1d._contentToClean=[];var fn=_8.byId(_1e["form"]);var _1f=_1e["content"]||{};if(fn){if(_1f){var _20=function(_21,_22){_9.create("input",{type:"hidden",name:_21,value:_22},fn);_1d._contentToClean.push(_21);};for(var x in _1f){var val=_1f[x];if(_4.isArray(val)&&val.length>1){var i;for(i=0;i<val.length;i++){_20(x,val[i]);}}else{if(!fn[x]){_20(x,val);}else{fn[x].value=val;}}}}var _23=fn.getAttributeNode("action");var _24=fn.getAttributeNode("method");var _25=fn.getAttributeNode("target");if(_1e["url"]){_1d._originalAction=_23?_23.value:null;if(_23){_23.value=_1e.url;}else{fn.setAttribute("action",_1e.url);}}if(!_24||!_24.value){if(_24){_24.value=(_1e["method"])?_1e["method"]:"post";}else{fn.setAttribute("method",(_1e["method"])?_1e["method"]:"post");}}_1d._originalTarget=_25?_25.value:null;if(_25){_25.value=this._iframeName;}else{fn.setAttribute("target",this._iframeName);}fn.target=this._iframeName;_5._ioNotifyStart(dfd);fn.submit();}else{var _26=_1e.url+(_1e.url.indexOf("?")>-1?"&":"?")+_1d.query;_5._ioNotifyStart(dfd);this.setSrc(this._frame,_26,true);}}catch(e){dfd.errback(e);}},_iframeOnload:function(){var dfd=this._currentDfd;if(!dfd){this._fireNextRequest();return;}var _27=dfd.ioArgs;var _28=_27.args;var _29=_8.byId(_28.form);if(_29){var _2a=_27._contentToClean;for(var i=0;i<_2a.length;i++){var key=_2a[i];for(var j=0;j<_29.childNodes.length;j++){var _2b=_29.childNodes[j];if(_2b.name==key){_9.destroy(_2b);break;}}}if(_27["_originalAction"]){_29.setAttribute("action",_27._originalAction);}if(_27["_originalTarget"]){_29.setAttribute("target",_27._originalTarget);_29.target=_27._originalTarget;}}_27._finished=true;}};_4.setObject("dojo.io.iframe",_c);return _c;});