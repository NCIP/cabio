<?xml version="1.0" encoding="UTF-8"?>

<!--************************************************************************
* Emma code coverage script for caBIO
*************************************************************************-->
		
<project name="caBIO_emma" default="help" basedir=".">

	<property name="project.home.dir" value="../cabioapi" />
	<property name="project.build.dir" value="${project.home.dir}/build" />
	<property name="project.output.dir" value="${project.home.dir}/output" />
  	<property name="coverage.dir" value="${project.output.dir}/coverage" />
  	<property name="emma.dir" value="${project.home.dir}/lib" />

  	<!-- this loads <emma> and <emmajava> custom tasks: -->
  	<taskdef resource="emma_ant.properties" classpathref="emma.lib" />

	<path id="emma.lib" >
    	<pathelement location="${emma.dir}/emma.jar" />
    	<pathelement location="${emma.dir}/emma_ant.jar" />
	</path>

	<!-- the jars we are interested in coverage for -->
    <path id="instr.lib" >
        <!--
        <fileset dir="${project.build.dir}/system/dist">
            <include name="sdk-client-framework.jar"/>
            <include name="sdk-core.jar"/>
            <include name="sdk-ws-framework.jar"/>
        </fileset>
        -->
        <fileset dir="${project.build.dir}/system/lib">
            <include name="*-client-framework.jar"/>
            <include name="*-beans.jar"/>
        </fileset>
    </path>
	
	<!-- the source for jars defined in instr.lib -->
	<path id="source.path" >
    	<pathelement location="${project.build.dir}/system/src" />
        <pathelement location="${project.home.dir}/src" />
	</path>
	
	<target name="help" 
			description="Lists commonly used targets">
		<echo>========================</echo>
		<echo>  caBIO Code Coverage</echo>
		<echo>========================</echo>
		<echo>Please read docs/README-emma.txt for a typical usage example.</echo>
		<echo>instr-system - Instrument caBIO jars and repackage system</echo>
		<echo>report       - Fetch coverage results from JBoss and create report</echo>
	</target>
		
  	<target name="clean" description="">
    	<delete dir="${coverage.dir}" quiet="true" />
  	</target>
	
  	<target name="init" depends="clean" description="">
    	<mkdir dir="${coverage.dir}" />
  	</target>

	<target name="instr-jars" 
			description="Instrument the jars of the system">
    	<mkdir dir="${coverage.dir}" />
	    <emma>
	    	<instr instrpathref="instr.lib"
    				mode="overwrite"
	            	metadatafile="${coverage.dir}/metadata.emma"
	            	merge="true">
	        	<filter value="*" />
	      	</instr>
	    </emma>
  	</target>

	<target name="instr-system" depends="instr-jars" 
			description="Instrument the code and repackage the system">

    	<copy todir="${project.build.dir}/system/lib" file="${emma.dir}/emma.jar" />
				
		<ant antfile="build-project.xml" inheritAll="false" target="package-system"/>
		<ant antfile="build-project.xml" inheritAll="false" target="Custom.dist"/>
		
	</target>
	
    <condition property="coverage.ready">
        <available file="${coverage.dir}/server.ec"/>
    </condition>

	<target name="get-coverage" unless="coverage.ready" 
            description="Retrieves coverage data from the server">
		<java classname="emma" classpathref="emma.lib">
			<arg value="ctl"/>
			<arg value="-connect"/>
			<arg value="localhost:47653"/>
			<arg value="-command"/> 
			<arg value="coverage.get,${coverage.dir}/server.ec"/> 
		</java>
		
		<!-- TODO: emma task current broken for command args.
		See http://sourceforge.net/tracker/index.php?func=detail&aid=1275523&group_id=108932&atid=651897
		
	     <emma verbosity="trace1">
	        <ctl connect="localhost:47653">
	          <command name="coverage.get" 
	          	args="${coverage.dir}/mycoverage.ec" />
	        </ctl>
	      </emma>
	      
	      -->
  	</target>
		
	<target name="report" depends="get-coverage" 
			description="Generates a coverage report">
    	<emma>
			<report sourcepathref="source.path">
	
		        <fileset dir="${coverage.dir}" >
		        	<include name="*.emma" />
		        	<include name="*.ec" />
		        </fileset>
	
	        	<html outfile="${coverage.dir}/coverage.html"
	             		depth="method"
	             		columns="name,class,method,block,line"/>
     	 	</report>
    	</emma>
  	</target>

</project>
